<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="javascripts/jquery-1.7.2.min.js"></script>
  </head>
  <body>
    <button id="discover-device">discover devices</button><br>
    <section id="discovered">
    </section>
    <button id="pick-image">pick image w/ Explicit Intent</button>
    <button id="edit-image">edit image</button>
    <hr>
    <output>
    <img>
    </output>
    <hr>
    <div id="console"></div>
  </body>

  <script>
  $("#pick-image,#edit-image").hide();
  var proxyurl, cameraurl;
  $("div#console").text(location.href)
    $("button#discover-device").on("click", function(){
      var intent = new WebKitIntent({
        "action": "chrome-extension://komasshu.info/dlnawrapper",
        "type": "text/url-list",
        data: 'proxyurl',
        service: 'chrome-extension://facphhlidnbehckiafllpiffdcekefak/_generated_background_page.html'
      });

      navigator.webkitStartActivity(intent, function(e){
        console.log("success")
        proxyurl = e
        $.getJSON(proxyurl+"/webintents/devices", function(e){
          console.log(e);
          cameraurl = e.location+e['location.webintents.org'].replace(/^\//, '')
          $("#discovered").html("<strong>"+cameraurl+"</strong>")
          $("#pick-image,#edit-image").fadeIn();

          console.log(cameraurl)
        })
      }, function(e){
        throw(e);
      })
    })



    $("button#pick-image").bind("click", function(e){
      var intent = new WebKitIntent({
        "action": "http://webintents.org/pick",
        "type": "image/*",
        "data": {"target": cameraurl}
      })
      navigator.webkitStartActivity(intent, onSuccess, onError);
    });
    $("button#edit-image").bind("click", function(e){
      var intent = new WebKitIntent({
        "action": "http://webintents.org/edit",
        "type": "image/*",
        "data": $("output > img").attr("src")
      })
      navigator.webkitStartActivity(intent, onSuccess, onError);
    });
    var onSuccess = function(e) {
      console.log("success")
      $("output > img").attr("src", e);
    }
    var onError = function(e) {
      console.log("error" + e)
    }
  </script>

</html>
